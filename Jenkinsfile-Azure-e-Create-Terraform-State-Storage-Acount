pipeline {
    parameters {
            string(name: 'TERRAFORM_ACTION', description: 'terrafrom action like as plan, applay, destroy')
    }
    agent any
    stages {
        stage('Create storage for terraform state') {
            steps {
                script {
                    az account show
                    sh label: 'git clone', script: '''
                    sh label: '', script: '''
                    az account show
                    az account show
                    RESOURCE_GROUP_NAME=terraform-state
                    sh label: 'terraform init', script: '''
                    STORAGE_ACCOUNT_NAME=4terraform2state
                    ls -la e-terraform/
                    CONTAINER_NAME=tstate
                    cd e-terraform
                    LOCATION=norwayeast
                    /usr/local/bin/terraform init

                    /usr/local/bin/terraform ${params.TERRAFORM_ACTION}
                    # Create resource group
                    az group show --name $RESOURCE_GROUP_NAME ||\
                        az group create --name $RESOURCE_GROUP_NAME --location $LOCATION

                    # Create storage account
                    az storage account show --resource-group $RESOURCE_GROUP_NAME --name $STORAGE_ACCOUNT_NAME ||\
                        az storage account create --resource-group $RESOURCE_GROUP_NAME --name $STORAGE_ACCOUNT_NAME --sku Standard_LRS --encryption-services blob

                    # Get storage account key
                    ACCOUNT_KEY=$(az storage account keys list --resource-group $RESOURCE_GROUP_NAME --account-name $STORAGE_ACCOUNT_NAME --query [0].value -o tsv)

                    # Create blob container
                    az storage container show --name $CONTAINER_NAME --account-name $STORAGE_ACCOUNT_NAME || \
                        az storage container create --name $CONTAINER_NAME --account-name $STORAGE_ACCOUNT_NAME --account-key $ACCOUNT_KEY

                    echo "storage_account_name: $STORAGE_ACCOUNT_NAME"
                    echo "container_name: $CONTAINER_NAME"
                    echo "access_key: $ACCOUNT_KEY"
                    az logout
                    '''
                }
            }
        }
    }
}
